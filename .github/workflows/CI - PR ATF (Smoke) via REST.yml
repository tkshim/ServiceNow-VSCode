name: CI - PR ATF (Smoke) via REST

on:
  pull_request:
    branches: [ main ]

concurrency:
  group: sn-ci
  cancel-in-progress: true

jobs:
  atf:
    runs-on: ubuntu-latest
    steps:
      - name: Run ATF suite (sn_cicd REST) and fail on errors
        env:
          SN_HOST: ${{ secrets.NOW_CI_INSTANCE_FQDN }}  # e.g. tshimmura002.service-now.com (NO https://)
          SN_USER: ${{ secrets.NOW_USERNAME }}
          SN_PASS: ${{ secrets.NOW_PASSWORD }}
          SUITE_ID: ${{ secrets.ATF_SUITE_SYS_ID }}
        run: |
          set -euo pipefail

          echo "=== Trigger ATF suite ==="
          curl -sS -u "$SN_USER:$SN_PASS" \
            -X POST "https://$SN_HOST/api/sn_cicd/testsuite/run?test_suite_sys_id=$SUITE_ID" \
            -H "Accept: application/json" \
            -o kickoff.json

          echo "=== kickoff.json ==="
          cat kickoff.json
          echo

          # kickoff から progress_id を取得（あなたのレスポンス形式に固定）
          PROGRESS_ID=$(python - <<'PY'
          import json
          d=json.load(open("kickoff.json"))
          try:
            print(d["result"]["links"]["progress"]["id"])
          except Exception as e:
            raise SystemExit(f"Could not find progress id at result.links.progress.id: {e}")
          PY
          )

          echo "progress_id=$PROGRESS_ID"
          echo

          # progress をポーリングし、result_id（links.results.id）が出るまで待つ
          echo "=== Poll progress until results link appears ==="
          RESULT_ID=""
          STATUS_LABEL=""
          ERROR_MSG=""

          # 最大 90 回 * 10 秒 = 900 秒（15分）待つ
          for i in {1..90}; do
            curl -sS -u "$SN_USER:$SN_PASS" \
              "https://$SN_HOST/api/sn_cicd/progress/$PROGRESS_ID" \
              -H "Accept: application/json" \
              -o progress.json

            STATUS_LABEL=$(python - <<'PY'
          import json
          d=json.load(open("progress.json"))
          r=d.get("result",{})
          print(r.get("status_label",""))
          PY
            )
            ERROR_MSG=$(python - <<'PY'
          import json
          d=json.load(open("progress.json"))
          r=d.get("result",{})
          print(r.get("error",""))
          PY
            )

            RESULT_ID=$(python - <<'PY'
          import json
          d=json.load(open("progress.json"))
          r=d.get("result",{})
          links=r.get("links",{})
          results=links.get("results",{})
          print(results.get("id",""))
          PY
            )

            echo "[$i] status_label=${STATUS_LABEL:-} result_id=${RESULT_ID:-}"

            # progress APIが明確なerrorを返したら即失敗
            if [ -n "${ERROR_MSG:-}" ]; then
              echo "Error returned by progress API: $ERROR_MSG"
              echo "=== progress.json ==="
              cat progress.json
              exit 1
            fi

            # result_id が出たら次へ
            if [ -n "${RESULT_ID:-}" ]; then
              echo "Found result_id=$RESULT_ID"
              break
            fi

            sleep 10
          done

          if [ -z "${RESULT_ID:-}" ]; then
            echo "Timed out: result_id was not found in progress response (expected result.links.results.id)."
            echo "=== last progress.json ==="
            cat progress.json
            exit 1
          fi

          echo
          echo "=== Fetch results ==="
          curl -sS -u "$SN_USER:$SN_PASS" \
            "https://$SN_HOST/api/sn_cicd/testsuite/results/$RESULT_ID" \
            -H "Accept: application/json" \
            -o results.json

          echo "=== results.json ==="
          cat results.json
          echo

          echo "=== Evaluate results.json strictly ==="
          python - <<'PY'
          import json, sys

          d = json.load(open("results.json"))
          r = d.get("result", {})

          suite_status = (r.get("test_suite_status", "") or "").lower()
          status_label = r.get("status_label", "")
          fail_cnt = int(r.get("rolledup_test_failure_count", 0) or 0)
          err_cnt  = int(r.get("rolledup_test_error_count", 0) or 0)

          print(f"status_label={status_label}")
          print(f"test_suite_status={suite_status}")
          print(f"failure_count={fail_cnt}, error_count={err_cnt}")

          if suite_status in ("success", "running") and fail_cnt == 0 and err_cnt == 0:
              print("ATF suite PASSED")
              sys.exit(0)

          print("ATF suite FAILED")
          sys.exit(1)
          PY
