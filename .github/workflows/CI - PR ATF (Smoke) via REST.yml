name: CI - PR ATF (Smoke) via REST

on:
  pull_request:
    branches: [ develop, main ]

concurrency:
  group: sn-ci
  cancel-in-progress: true

jobs:
  atf:
    runs-on: ubuntu-latest
    steps:
      - name: Run ATF suite (sn_cicd REST) and fail on errors
        env:
          SN_HOST: ${{ secrets.NOW_CI_INSTANCE_FQDN }}  # e.g. tshimmura002.service-now.com (NO https://)
          SN_USER: ${{ secrets.NOW_USERNAME }}
          SN_PASS: ${{ secrets.NOW_PASSWORD }}
          SUITE_ID: ${{ secrets.ATF_SUITE_SYS_ID }}
        run: |
          set -euo pipefail

          echo "=== Trigger ATF suite ==="
          curl -sS -u "$SN_USER:$SN_PASS" \
            -X POST "https://$SN_HOST/api/sn_cicd/testsuite/run?test_suite_sys_id=$SUITE_ID" \
            -H "Accept: application/json" \
            -o kickoff.json

          echo "=== kickoff.json ==="
          cat kickoff.json
          echo

          # kickoff から progress_id を取得（あなたのレスポンス形式に固定）
          PROGRESS_ID=$(python - <<'PY'
          import json
          d=json.load(open("kickoff.json"))
          try:
            print(d["result"]["links"]["progress"]["id"])
          except Exception as e:
            raise SystemExit(f"Could not find progress id at result.links.progress.id: {e}")
          PY
          )

          echo "progress_id=$PROGRESS_ID"
          echo

          # progress をポーリングし、result_id（links.results.id）が出るまで待つ
          echo "=== Poll progress until results link appears ==="
          RESULT_ID=""
          STATUS_LABEL=""
          STATUS_DETAIL=""
          ERROR_MSG=""

          # 最大 90 回 * 10 秒 = 900 秒（15分）待つ
          for i in {1..90}; do
            curl -sS -u "$SN_USER:$SN_PASS" \
              "https://$SN_HOST/api/sn_cicd/progress/$PROGRESS_ID" \
              -H "Accept: application/json" \
              -o progress.json

            # ステータス系をログ表示（キーは環境により変わるので候補で拾う）
            STATUS_LABEL=$(python - <<'PY'
          import json
          d=json.load(open("progress.json"))
          r=d.get("result",{})
          print(r.get("status_label",""))
          PY
            )
            STATUS_DETAIL=$(python - <<'PY'
          import json
          d=json.load(open("progress.json"))
          r=d.get("result",{})
          print(r.get("status_detail",""))
          PY
            )
            ERROR_MSG=$(python - <<'PY'
          import json
          d=json.load(open("progress.json"))
          r=d.get("result",{})
          print(r.get("error",""))
          PY
            )

            RESULT_ID=$(python - <<'PY'
          import json
          d=json.load(open("progress.json"))
          r=d.get("result",{})
          links=r.get("links",{})
          results=links.get("results",{})
          print(results.get("id",""))
          PY
            )

            echo "[$i] status_label=${STATUS_LABEL:-} result_id=${RESULT_ID:-}"

            # もし明確なエラーが出ていたら即失敗
            if [ -n "${ERROR_MSG:-}" ]; then
              echo "Error returned by progress API: $ERROR_MSG"
              echo "=== progress.json ==="
              cat progress.json
              exit 1
            fi

            # result_id が出たら次へ
            if [ -n "${RESULT_ID:-}" ]; then
              echo "Found result_id=$RESULT_ID"
              break
            fi

            # Pendingが続く場合もあるので待つ（必要なら sleep 秒を調整）
            sleep 10
          done

          if [ -z "${RESULT_ID:-}" ]; then
            echo "Timed out: result_id was not found in progress response (expected result.links.results.id)."
            echo "=== last progress.json ==="
            cat progress.json
            exit 1
          fi

          echo
          echo "=== Fetch results ==="
          curl -sS -u "$SN_USER:$SN_PASS" \
            "https://$SN_HOST/api/sn_cicd/testsuite/results/$RESULT_ID" \
            -H "Accept: application/json" \
            -o results.json

          echo "=== results.json ==="
          cat results.json
          echo

          # まずは “失敗っぽい”文字列で検出（あなたのresults JSONに合わせて後で厳密化）
          if grep -Ei '"(status|result|status_label)".*"(fail|failed|error)"' -n results.json; then
            echo "ATF suite failed (detected failure markers in results.json)"
            exit 1
          fi

          echo "ATF suite passed (or no failure detected)"
